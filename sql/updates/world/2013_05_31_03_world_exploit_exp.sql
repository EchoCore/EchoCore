-- DB/Exploit: Fix: Exp-Exploit with: | by FireEmerald
-- * NPC Skittering Swarmer / Azjol-Nerub.
-- * NPC Temporal Parasite / Western Plaguelands.

SET @SWARMER   := 32593; -- Skittering Swarmer
SET @PARASITE  := 10717; -- Temporal Parasite
SET @SPELL     := 16613; -- Displacing Temporal Rift
SET @QUEST     :=  4971; -- A Matter of Time

UPDATE `creature_template` SET `flags_extra` = 64 WHERE `entry` IN (@SWARMER, @PARASITE);
UPDATE `creature` SET `spawntimesecs` = 36000 WHERE `id` = @SWARMER;

-- Disable quest item if the npc is already summoned or the player has the quest completed, but not yet rewarded.
DELETE FROM `conditions` WHERE `SourceTypeOrReferenceId` = 17 AND `SourceEntry` = @SPELL;
INSERT INTO `conditions` (SourceTypeOrReferenceId, SourceGroup, SourceEntry, SourceId, ElseGroup, ConditionTypeOrReference, ConditionValue1, ConditionValue2, ConditionValue3, NegativeCondition, ErrorType, comment ) VALUES
(17, 0, @SPELL, 0, 0, 29, @PARASITE, 100, 0, 1, 0, "Cant use Temporal Displacer within 100 yards of Temporal Parasite"),
(17, 0, @SPELL, 0, 0, 28, @QUEST, 0, 0, 1, 0, "Cant use Temporal Displacer, if player has quest objective completed, but not yet rewarded");

UPDATE `version` SET `db_version` = 'EDB 1.043' WHERE `core_version` = 'EchoCore';
